<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Projects & Learnings</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <h1>Projects & Learnings</h1>
        <p>Technical notes, experiments and updates</p>
        <p>
            <a href="mailto:lanseg@proton.me">lanseg@proton.me</a> -
            <a href="https://github.com/lanseg">github.com/lanseg</a> -
            <a href="plans.html">plans</a>
        </p>
    </header>
    <main>
        <!-- <article class="entry">
            <time datetime="2025-06-10">2025-06-12</time>
            <h2><a id="TITLEID" href="#TITLEID">Title</a></h2>
            <div class="tags">
                <div class="tag">TAG</div>
            </div>
            <p>Text content</p>
            <div class="diff">
                <div class="column">
                    <img width="522px" height="130px" alt="Image left">
                    <div class="label">Caption left</div>
                </div>
                <div class="column">
                    <img width="522px" height="130px" alt="Image right">
                    <div class="label">Caption right</div>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <td class="label">Header</td>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Row</td></tr>
                </tbody>
            </table>
            <code>Code</code>
        </article> -->

        <article class="entry">
            <time datetime="2025-08-07">2025-08-07</time>
            <h2>
                <a id="python-sailfish-rpm" href="#python-sailfish-rpm">
                    Newer Python and yt-dlp for the Sailfish OS
                </a>
            </h2>
            <div class="tags">
                <div class="tag">Sailfish OS</div>
                <div class="tag">Python</div>
                <div class="tag">yt-dlp</div>
                <div class="tag">Jolla</div>
            </div>
            <p>
                I moved to the Redeer C2, community edition with Sailfish OS. Not 100% voluntarily,
                but not against my will either. My phone's touch screen just broke, and I needed a
                replacement.
            </p>
            <p>
                I still think that Sailfish OS is a nice system, and its user interface is the only
                mobile Linux UI that is customer-ready. Unfortunately, the system lacks many common
                applications, such as a video player (the music player exists and is okay for my
                needs) or a YouTube client. So my plan was to download videos with yt-dlp and view \
                them locally.
            </p>
            <h3>Part 1: <s>yt-dlp</s> Python</h3>
            <p>
                What could be simpler than downloading and running yt-dlp from
                <a href="https://github.com/yt-dlp/yt-dlp">github</a> or installing from pip? But
                my phone only had Python 3.8 (python3-base-3.8.18) and yt-dlp dropped support for it
                almost a year ago (<a href="https://github.com/yt-dlp/yt-dlp/pull/11321">#1132</a>).
            </p>
            <p>
                I was not looking for an easy way, so I decided to cross-compile python myself. But
                I was not looking for a dirty way either, so I decided to create an RPM package that
                could be installed independently from the original Python and removed later if
                needed.
            </p>
            <h4>Building and packaging</h4>
            <p>
                Let's assume you have already followed the
                <a href="https://docs.sailfishos.org/Tools/Sailfish_SDK/#all-download-options">
                    Sailfish SDK installation instructions
                </a> and have sfdk installed. Make sure to do all the stuff within a workspace,
                because Sailfish SDK uses a VirtualBox VM or Docker container as a build host and
                mounts workspace directory there.

            <div class="row">
                <div class="figure full">
                    <code>include(`2025-08-07/sfdk-config.txt')</code>
                </div>
            </div>
            <p>
                That should be enough: a somewhat optimized, somewhat stripped, complete python
                distribution ready for common tasks including downloading youtube videos with
                yt-dlp.
            </p>
            <div class="row">
                <div class="figure full">
                    <code>include(`2025-08-07/python-3.13.6.spec')</code>
                    <div class="label">
                        The RPM spec unpacks, compiles, and prepares a large package
                    </div>
                </div>
            </div>
            </p>
            <h3>Part 2: yt-dlp</h3>
            <p>With the latest stable Python and pip, it's enough to just install it from pip:</p>
            <div class="row">
                <div class="figure full">
                    <code>defaultuser $ python3 -m pip install -U "yt-dlp[default]"</code>
                </div>
            </div>
            <p>If you are going to use yt-dlp, there is no need to create an RPM package.</p>
            <h3>Part 3: VLC</h3>
            <p>
                Next time - VLC, probably. It works, but requires some styling to look like other
                Sailfish apps.
            </p>
            <div class="row">
                <div class="figure">
                    <img src="2025-08-07/vlc_maybe.jpg" width="657px" height="211px"
                        alt="Terminal with a long error log and vlc window without video" />
                    <div class="label">Terminal where I started VLC with lots of error logs and broken app window</div>
                </div>
            </div>
        </article>

        <article class="entry">
            <time datetime="2025-06-10">2025-06-12</time>
            <h2>
                <a id="exploring_max_messenger" href="#exploring_max_messenger">
                    Exploring MAX messenger
                </a>
            </h2>
            <div class="tags">
                <div class="tag">messengers</div>
                <div class="tag">android</div>
                <div class="tag">reverse engineering</div>
            </div>
            <p>
                MAX messenger is a government-forced Russian messenger that is planned to replace
                WhatsApp, Facebook messenger and other Western propaganda spreading machines. And
                the Telegram too. While there is nothing interesting about the interface, there
                could be something interesting inside so I installed the app on my Android emulator
                and started to explore it.
            </p>
            <h3>TL;DR</h3>
            <p>
                Nothing unexpected, yet another messenger with an unclear future. Not a KGB trojan
                surveillance app, just as private as any other messenger which is not focused on
                protecting your data. It also needs a working phone number to register, so you can
                forget about anonymity.
            </p>
            <p>
                The only somewhat interesting thing is that it has a TamTam messenger inside, so
                it's probably based on a TamTam codebase.
            </p>
            <h3>Package details</h3>
            <table>
                <thead>
                    <tr>
                        <td colspan="2" class="label">Version information</td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Origin</td>
                        <td>RuStore</td>
                    </tr>
                    <tr>
                        <td>Package</td>
                        <td>ru.oneme.app</td>
                    </tr>
                    <tr>
                        <td>Version</td>
                        <td>25.7.1</td>
                    </tr>
                </tbody>
            </table>
            <table>
                <thead>
                    <tr>
                        <td colspan="3" class="label">Package content</td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>d88c78a92d75f0319af1a95b59e3867e</td>
                        <td>23M</td>
                        <td>base.apk</td>
                    </tr>
                    <tr>
                        <td>7ef573467d338b6411ceb80cd278f9cb</td>
                        <td>2.8M</td>
                        <td>split_config.mdpi.apk</td>
                    </tr>
                    <tr>
                        <td>0d978dc58e071136cddc8a815311154f</td>
                        <td>209K</td>
                        <td>split_config.ru.apk</td>
                    </tr>
                    <tr>
                        <td>b3c75d266a1f1a55833cb9f052b9e075</td>
                        <td>26M</td>
                        <td>split_config.x86_64.apk</td>
                    </tr>
                </tbody>
            </table>
            <h3>Permissions</h3>
            <p>Like any other messenger, it can read and write media and storage, use camera and
                microphone, prevent device lock, use vibration or show full screen intents, update app
                badges and settings on different android-based platforms.
            </p>
            <p>Compared
                <a href="./2025-07-24/permissions-max-25.7.1.txt">Max 25.7.1</a>,
                <a href="./2025-07-24/permissions-signal-7.45.2.txt">Signal 7.45.3</a>,
                <a href="./2025-07-24/permissions-telegram-11.13.3.txt">Telegram 11.13.3</a>,
                <a href="./2025-07-24/permissions-threema-6.1.1.txt">Threema 6.1.1</a>,
                <a href="./2025-07-24/permissions-wechat-8.0.58.txt">WeChat 8.0.68</a> and
                <a href="./2025-07-24/permissions-whatsapp-2.25.21.14.txt">WhatsApp 2.25.21.4</a>,
                detailed comparison table is here: <a href="./2025-07-24/comparison.txt">comparison.txt</a>.
            </p>
            <h3>Dependencies</h3>
            <p>The messenger uses open source libraries, some of them are well known and widely used
                in Java (Apache commons, Apache http, FasterXML, org/JSON, LZ4-java, OkHTTP3, WebRTC,
                etc). The list below contains specific or not so famous libraries:</p>
            <table>
                <thead>
                    <tr>
                        <td>Library</td>
                        <td>Description</td>
                        <td>Sources</td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="3" class="label">Odnoklassniki (ru/ok)</td>
                    </tr>
                    <tr>
                        <td>android</td>
                        <td>A somewhat lower-level code (api, http, compression, etc)</td>
                        <td rowspan="6">N/A</td>
                    </tr>
                    <tr>
                        <td>messages</td>
                        <td>Reused code from OK.ru messenger</td>
                    </tr>
                    <tr>
                        <td>onechat</td>
                        <td>Utility classes for the reactions view</td>
                    </tr>
                    <tr>
                        <td>tamtam</td>
                        <td>Some Russian messenger</td>
                    </tr>
                    <tr>
                        <td>tracer</td>
                        <td>
                            OK-Tech service for profiling and failure reporting, closed source.
                        </td>
                    </tr>
                    <tr>
                        <td>util</td>
                        <td>LZ4 compression support</td>
                    </tr>
                    <tr>
                        <td colspan="3" class="label">Analytics</td>
                    </tr>
                    <tr>
                        <td>tracker.my.com</td>
                        <td>Ads and analytics framework</td>
                        <td>
                            <a href="https://github.com/myTrackerSDK/mytracker-android">GitHub</a>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="3" class="label">Facebook</td>
                    </tr>
                    <tr>
                        <td>fresco</td>
                        <td>System for displaying images in Android</td>
                        <td><a href="https://github.com/facebook/fresco">GitHub</a></td>
                    </tr>
                    <tr>
                        <td colspan="3" class="label">System and GUI libraries</td>
                    </tr>
                    <tr>
                        <td>BoltsFramework</td>
                        <td>Somewhat low-level async task management</td>
                        <td>
                            <a href="https://github.com/BoltsFramework/Bolts-Android">GitHub</a>
                        </td>
                    </tr>
                    <tr>
                        <td>Conductor</td>
                        <td>BlueLine Labs' Framework for building View-based Android applications.</td>
                        <td>
                            <a href="https://github.com/bluelinelabs/Conductor">GitHub</a>
                        </td>
                    </tr>
                    <tr>
                        <td>GPUImageNativeLibrary</td>
                        <td>CATS OSS Something as similar to iOS GPUImage as possible.</td>
                        <td>
                            <a href="https://github.com/cats-oss/android-gpuimage">GitHub</a>
                        </td>
                    </tr>
                    <tr>
                        <td>FastScroll</td>
                        <td>
                            FutureMind's Scroll and section indexer for recycler view.
                        </td>
                        <td>
                            <a href="https://github.com/FutureMind/recycler-fast-scroll">GitHub</a>
                        </td>
                    </tr>
                    <tr>
                        <td>ProcessPhoenix</td>
                        <td>Simplifies restarting application process</td>
                        <td>
                            <a href="https://github.com/JakeWharton/ProcessPhoenix">GitHub</a>
                        </td>
                    </tr>
                    <tr>
                        <td>ShortcutBadger</td>
                        <td>Show the count of unread messages as a badge on the app shortcut</td>
                        <td>
                            <a href="https://github.com/leolin310148/ShortcutBadger">GitHub</a>
                        </td>
                    </tr>
                    <tr>
                        <td>libphonenumber</td>
                        <td>Android port of Google's libphonenumber.</td>
                        <td>
                            <a href="https://github.com/MichaelRocks/libphonenumber-android">GitHub</a>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="3" class="label">Common libraries</td>
                    </tr>
                    <tr>
                        <td>MessagePack</td>
                        <td>Binary serialization format (like Google's protobuf)</td>
                        <td>
                            <a href="https://github.com/msgpack/msgpack-java">GitHub</a>
                        </td>
                    </tr>
                    <tr>
                        <td>ReactiveX</td>
                        <td>Reactive programming for Java</td>
                        <td><a href="https://github.com/ReactiveX">GitHub</a></td>
                    </tr>
                </tbody>
            </table>
            <h3>Used service web links </h3>
            <ul>
                <li>api.oneme.ru</li>
                <li>max.ru</li>
                <li>api-tg.oneme.ru</li>
                <li>api-test.oneme.ru</li>
                <li>api-test-gost[,2,3,4].oneme.ru</li>
                <li>tracker-api.vk-analytics.ru</li>
            </ul>
            <h3>Debugging</h3>
            There is not much I can say without the debugging, so I will need to set up this
            messenger on my phone to try it out.
        </article>
        <article class="entry">
            <time datetime="2025-07-01">2025-07-01</time>
            <h2>
                <a id="openconnect_sailfish_p2" href="#openconnect_sailfish_p2">
                    Making OpenConnect work on Sailfish OS, Part 2: Workaround
                </a>
            </h2>
            <div class="tags">
                <div class="tag">OpenConnect</div>
                <div class="tag">Sailfish OS</div>
                <div class="tag">VPN</div>
            </div>
            <p>
                At least, I need to make a note on how to use openconnect even without gui. Sailfish
                has an openconnect client by default, but it doesn't have default vpn scripts:
            </p>
            <div class="row">
                <div class="figure full">
                    <code># openconnect  https://somehost.com/?somekey
...
/bin/sh: /etc/openconnect/vpnc-script: not found
Script '/etc/openconnect/vpnc-script' returned error 127
/bin/sh: /etc/openconnect/vpnc-script: not found
Script '/etc/openconnect/vpnc-script' returned error 127
...</code>
                </div>
            </div>
            <p>
                But ones from the
                <a href="https://gitlab.com/openconnect/vpnc-scripts">OpenConnect's git repository</a>
                work well and copying them to /etc/openconnect directory solves an issue. Of course, if
                you don't want to put self generated files to the system directories, you can set the
                script location:
            </p>
            <div class="row">
                <div class="figure full">
                    <code># openconnect -s /path/to/scripts/vpnc-script https://somehost.com/?somekey</code>
                </div>
            </div>
            <p>
                Good thing that it works by itself, bad thing that it is not integrated with the UI,
                so I had to try other options:
            </p>
            <h3>Automatic cookie</h3>
            <p>
                I expected that it will fetch the cookie and certificate from credentials, but it
                didn't work, I kept getting those getaddrinfo error messages.
            </p>
            <h3>Manual cookie</h3>
            <p>If connman cannot fetch the cookie, I should do it myself:</p>
            <div class="row">
                <div class="figure full">
                    <code>include(`2025-07-03/openconnect-logs.txt')</code>
                </div>
            </div>
            <p>And it worked! Just pay attention when copy-pasting text from the fingerterm, as it
                will add spaces where the text was broken by the side of the screen.
            </p>
            <div class="row">
                <div class="figure">
                    <img src="2025-07-03/entercookie.png" width="360px" height="331px"
                        alt="Sailfish OS OpenConnect configuration with cookie and certificate fingerprint" />
                    <div class="label">Sailfish OS OpenConnect configuration</div>
                </div>
            </div>
            <p>Next time I'll try automate cookie update.</p>
        </article>

        <article class="entry">
            <time datetime="2025-06-13">2025-06-13</time>
            <h2>
                <a id="openconnect_sailfish_p1" href="#openconnect_sailfish_p1">
                    Making OpenConnect work on Sailfish OS
                </a>
            </h2>
            <div class="tags">
                <div class="tag">OpenConnect</div>
                <div class="tag">Sailfish OS</div>
                <div class="tag">VPN</div>
                <div class="tag">connman</div>
            </div>
            <p>
                I'm one of the rare owners of a Sailfish OS device. I had an original Jolla, a Sony
                XPeria device with Sailfish and now I use Redeer C2. For me it is an only end-user
                ready Linux mobile OS-es, but one thing kept bothering me - an OpenVPN (ocserv)
                connection to my home network.
            </p>
            <p>
                The problem was unclear: VPN connection kept flashing while trying to connect but
                each attempt ended with "Connection problem" error. No notifications, no detailed
                error messages. What is wrong with you? It worked on Android with the AnyConnect
                client, it worked on a generic Linux with terminal client for "openconnect". And
                the terminal client worked well even on the same Sailfish OS. What could be wrong?
            </p>
            <p>Ok. Let's look in the logs:</p>
            <div class="row">
                <div class="figure full">
                    <code>[root@JollaC2 defaultuser]# journalctl -r | grep -i vpn
...
JollaC2 connman-vpnd[2317]: Failed to open HTTPS connection to my-vpn.somevds.ch/?somesecretkey
JollaC2 lipstick[2684]: [D] unknown:0 - VPN connection property changed: "State" QVariant(QString, "configuration") "/net/connman/vpn/connection/https___my_vpn_somevds_ch__somesecretkey_Sailfish OS_org" "Home"
JollaC2 connman-vpnd[2317]: getaddrinfo failed for host 'my-vpn.somevds.ch/?somesecretkey': Name or service not known
JollaC2 connman-vpnd[2317]: POST https://my-vpn.somevds.ch/?somesecretkey
...</code>
                </div>
            </div>
            <p>
                The culprit! It thinks that my whole url with a path and a parameter. A bit weird,
                because my OpenConnect server uses camouflage mode and I don't want to disable it,
                but connman doesn't know how to use it. I'll try to find a workaround next time.
            </p>
        </article>
        <article class="entry">
            <time datetime="2025-06-10">2025-06-12</time>
            <h2>
                <a id="openwrt_greench" href="#openwrt_greench">
                    Configuring Green.ch DHCP on an OpenWRT router
                </a>
            </h2>
            <div class="tags">
                <div class="tag">OpenWRT</div>
                <div class="tag">green.ch</div>
                <div class="tag">DHCP</div>
            </div>
            <p>
                I bought a Banana Pi BPI-R3 router, installed an OpenWRT firmware, but couldn't get
                an IP address from my provider, green.ch. I tried to use the same MAC address, but
                it didn't work so I had to go deeper and what is the simplest way to debug such an
                issue? Compare the dumps and see the difference, of course. So I connected WAN port
                of a working router to my laptop and looked at DHCP packets, then I did the same for
                my non-working router and saw a difference:
            </p>
            <div class="diff">
                <div class="column figure">
                    <img src="2025-06-10/dhcp-asus-dump.png" width="522px" height="130px"
                        alt="Wireshark output dump, working DHCP request">
                    <div class="label">Working DHCP request</div>
                </div>
                <div class="column figure">
                    <img src="2025-06-10/dhcp-banana-dump.png" width="522px" height="130px"
                        alt="Wireshark output dump, DHCP request that was ignored by provider">
                    <div class="label">Ignored DHCP request</div>
                </div>
            </div>
            <p>
                So, the only difference was that the provider expected packet to be sent from a
                802.1q vlan with ID 10. I've added it to the network config (/etc/config/network)
                and everything worked.
            </p>
            <div class="row">
                <div class="figure full">
                    <code>include(`2025-06-10/openwrt-vlan.txt')</code>
                </div>
            </div>
        </article>
</body>

</html>